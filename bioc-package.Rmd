# Making a Bioconductor package {#bioc-package}

This chapter demonstrates the making of a Bioconductor package using a workflow
that includes the CRAN package `r BiocStyle::CRANpkg("usethis")` and the
Bioconductor package `r BiocStyle::Biocpkg("biocthis")`.

This is just one example of an opinionated workflow for making a
Bioconductor-friendly package, highlighting accessory packages
with the goal of helping automate the process of creating R packages for
Bioconductor or making them Bioconductor-friendly.

It is not a requirement to follow this workflow when preparing a package for
submission to the Bioconductor repository.
Many package developers learn from the experience of developing their first
packages and develop their own personal preferences and templates,
when working on their subsequent packages.

Throughout this chapter, this example is used to illustrate essential and
recommended components for Bioconductor packages, to give readers knowledge
and information allowing them to develop Bioconductor packages indepedently
of this workflow, if they so wish.

## Environment

This workflow was written on the operating system macOS Big Sur.
Other operating systems may require some adjustments.

This workflow uses
[RStudio Desktop](https://www.rstudio.com/products/rstudio/download/).

This workflow was written using R version 4.1.2 (2021-11-01) -- "Bird Hippie".

This workflow starts in the RStudio application, outside of any RStudio project.

![Initial state of the RStudio application.](images/rstudio-initial-state.png){width=100%}

## Install accessory packages

First, we install the CRAN package `r BiocStyle::CRANpkg("remotes")`, if it is
not installed yet.

```{r, eval=FALSE}
if (!requireNamespace("remotes", quietly = TRUE)) {
    install.packages("remotes")
}
```

Next, we immediately used the newly installed package to install a number of
CRAN packages that will be used to develop the new Bioconductor package.

```{r, eval=FALSE}
remotes::install_cran(
    c(
        "available",
        "BiocManager",
        "biocthis",
        "devtools",
        "knitr",
        "pkgdown",
        "RefManageR",
        "rmarkdown",
        "rstudioapi",
        "sessioninfo",
        "styler",
        "usethis"
    )
)
```

Next, we install the Bioconductor package `r BiocStyle::Biocpkg("BiocStyle")`,
if it is not installed yet.
That package will be used for styling the vignettes of the new Bioconductor
package and linking to other packages.

```{r, eval=FALSE}
if (!requireNamespace("BiocStyle", quietly = TRUE)) {
    BiocManager::install("BiocStyle")
}
```

## Check if the package name is available on CRAN and Bioconductor

Packages submitted to the Bioconductor repository must have a name that is
not currently used on neither CRAN nor Bioconductor.
Furthermore, it is a good idea to check whether the package name exists
as a GitHub repository, in case another package with that name is being 
developed and/or submitted.

We use the newly installed CRAN package `r BiocStyle::CRANpkg("available")`
to check whether the name that we want to give to the new package is already
in use in either Bioconductor or CRAN, or has a meaning that we might not be
aware of.

```{r, eval=FALSE}
available::available("MyBioconductorPackage")
```

If prompted whether to report potentially offensive results in the
Urban Dictionary, type `Y` or `N` depending on your preference, and press the
Return key.

Note that the function `available::available()` displays some information in
the R console of the RStudio application, while simultaneously opening a number
of tabs in our default web browser.

The information in the R console indicates whether the package name
is syntactically valid and not in use yet on CRAN, Bioconductor, or GitHub.
If you opted for the Urban Dictionary, the console also reports the meaning
and sentiment analysis for words and acronym that the name of the package,
as well as sub-strings and acronym that the name of the package contains

Each tab in your default web browser reports the result of a search
on Wikipedia, Wiktionary, and other websites, for the name of the package,
sub-strings, and acronyms.
It is up to you to check the contents of those pages and decide whether you
wish to continue the process with that package name.

## Create a package template with `usethis`

When we are satisfied with the name of your package, we use the function
`usethis::create_package()` to create a package template.
In this example, we first change directory to `~/Desktop`, to create 

```{r, eval=FALSE}
setwd("~/Desktop")
usethis::create_package("MyBioconductorPackage")
```

The R console displays some information as the package template is created.
In this example, we saw:

```
✔ Creating 'MyBioconductorPackage/'
✔ Setting active project to '/Users/kevin/Desktop/MyBioconductorPackage'
✔ Creating 'R/'
✔ Writing 'DESCRIPTION'
Package: MyBioconductorPackage
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R (parsed):
    * First Last <first.last@example.com> [aut, cre] (YOUR-ORCID-ID)
Description: What the package does (one paragraph).
License: `use_mit_license()`, `use_gpl3_license()` or friends to
    pick a license
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.1.2
✔ Writing 'NAMESPACE'
✔ Writing 'MyBioconductorPackage.Rproj'
✔ Adding '^MyBioconductorPackage\\.Rproj$' to '.Rbuildignore'
✔ Adding '.Rproj.user' to '.gitignore'
✔ Adding '^\\.Rproj\\.user$' to '.Rbuildignore'
✔ Opening '/Users/kevin/Desktop/MyBioconductorPackage/' in new RStudio session
✔ Setting active project to '<no active project>'
```

The RStudio application then reloads and opens the RStudio project on the new
package in a new RStudio application window.

![Initial state of the RStudio project for the new package.](images/rstudio-package-initial-state.png){width=100%}

The package template provided by the CRAN package
`r BiocStyle::CRANpkg("usethis")` includes some of the essential files that make
an R package.
Alphabetically:

- The optional file `.gitignore` is used to declare file names and patterns that
  will be ignored by git version control.
- The optional file `.Rbuildignore` is used to declare file names that will be
  ignored when the package is built.
- The essential file `DESCRIPTION` declares information about the package,
  its authors, licensing, and additional information relevant for package
  development and documentation.
- The optional file `MyBioconductorPackage.Rproj` is used by the RStudio
  application to store project settings.
- The essential file `NAMESPACE` is used to declare functions imported from
  other packages (i.e., dependencies) and functions exported by the new package.
- The essential directory `R/` - initially empty - is used to store R scripts
  that contain the code of the new package.

## Create template scripts using `biocthis`

At this point, we use the Bioconductor package
`r BiocStyle::Biocpkg("biocthis")` to generate some R scripts with the goal of
helping automate the process of creating R packages for Bioconductor or making
them Bioconductor-friendly.

```{r, eval=FALSE}
biocthis::use_bioc_pkg_templates()
```

The R console display information are a sub-directory `dev/` and several R
scripts are created.

```
✔ Setting active project to '/Users/kevin/Desktop/MyBioconductorPackage'
✔ Creating 'dev/'
✔ Adding '^dev$' to '.Rbuildignore'
✔ Writing 'dev/01_create_pkg.R'
• Modify 'dev/01_create_pkg.R'
✔ Writing 'dev/02_git_github_setup.R'
• Modify 'dev/02_git_github_setup.R'
✔ Writing 'dev/03_core_files.R'
• Modify 'dev/03_core_files.R'
✔ Writing 'dev/04_update.R'
• Modify 'dev/04_update.R'
```

In the next sections, we will go through those R scripts in turn.

## Create the R package

Open the file `dev/01_create_pkg.R`.

Carefully read the contents of the file, including comments and code, as we have
run most of that code already in the previous steps.

In this example, we have already run all the code in that script, so we can
directly open the file `dev/02_git_github_setup.R`.
We can click on the tab of the file already open in the Source panel of the
RStudio application, or we can run the last line of code in the script
`dev/01_create_pkg.R`.

```{r, eval=FALSE}
rstudioapi::navigateToFile(usethis::proj_path("dev", "02_git_github_setup.R"))
```

## Exclude files from git version control

In this example, the first step in the script `02_git_github_setup.R` is
to add a line in the file `.gitignore`, declaring that any file ending with the
extension `.Rproj` should be ignored from git version control.

Packages submitted to the Bioconductor repository should not contain files with
that extension, as those files are only useful on the computer of package
developers using the RStudio application.
Those files have no use on the Bioconductor repository.

```{r, eval=FALSE}
usethis::use_git_ignore("*.Rproj")
```

If you wish to visualise the change, you can open the file `.gitignore`.
You will see that the last line of the file now declared `*.Rproj`.

## First commit

The Git panel of the RStudio application should now list a number of files
created by the CRAN package `r BiocStyle::CRANpkg("usethis")` in the previous
step.
Those files - `.Rbuildignore`, `DESCRIPTION`, and `NAMESPACE` - are the first
files of the new Bioconductor package.
They must be commited to the git repository.

Tick the checkbox next to the files - ignore the directory `dev/` created
earlier by the Bioconductor package `BiocStyle::Biocpkg("biocthis")` - and click
the button `Diff`.

![Commit the files generated by `usethis::create_package()`](images/git-commit-usethis.png)

Add a commit message and click the button `Commit`.

![Write a commit message.](images/git-commit-usethis-message.png)

## Deprecated

### usethis

The function `usethis::create_package()` can be used to initialise the skeleton of an R package.

```{r, eval=FALSE}
usethis::create_package("~/Desktop/NewBiocPackage")
```

That command will initialise the skeleton of an R package in the requested directory.
The name of the package will be set to the name of the new directory, in this case `NewBiocPackage`.

```
✓ Creating '/Users/kevin/Desktop/NewBiocPackage/'
✓ Setting active project to '/Users/kevin/Desktop/NewBiocPackage'
✓ Creating 'R/'
✓ Writing 'DESCRIPTION'
Package: NewBiocPackage
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R (parsed):
    * First Last <first.last@example.com> [aut, cre] (YOUR-ORCID-ID)
Description: What the package does (one paragraph).
License: `use_mit_license()`, `use_gpl3_license()` or friends to
    pick a license
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.0.0
✓ Writing 'NAMESPACE'
✓ Writing 'NewBiocPackage.Rproj'
✓ Adding '^NewBiocPackage\\.Rproj$' to '.Rbuildignore'
✓ Adding '.Rproj.user' to '.gitignore'
✓ Adding '^\\.Rproj\\.user$' to '.Rbuildignore'
✓ Opening '/Users/kevin/Desktop/NewBiocPackage/' in new RStudio session
✓ Setting active project to '<no active project>'
```

### biocthis

The `r BiocStyle::Biocpkg('biocthis')` package provide convenient utilities to automate package and project setup for Bioconductor packages.

- [`biocthis::use_bioc_pkg_templates()`](https://lcolladotor.github.io/biocthis/reference/use_bioc_pkg_templates.html) creates four `dev/*.R` scripts that guide you in the process of setting up an RStudio project for a Bioconductor-friendly R package. 
- 2021-01-28 [two minute video](https://youtu.be/3fLNsLchPnI) in Spanish for ConectaR 2021. [Slides in Spanish](https://speakerdeck.com/lcolladotor/biocthis-conectar2021).
- 2020-11-05 [slides in English](https://speakerdeck.com/lcolladotor/biocthis-tab) for the Bioconductor Technical Advisory Board. 
- 2020-09-10 [55 minute video in English](https://youtu.be/aMTxkYsM-8o). [ Slides in English](https://speakerdeck.com/lcolladotor/making-bioc-packages-with-biocthis).

## Resources

> Contribute!
> 
> Introduce and discuss the links below.

- [Link to Kayla’s from Bioc2020](TODO)
- [BJ’s Boston Meetup](TODO)
- [Saskia’s video](TODO)
- [Template Bioconductor package (in development)](https://github.com/kevinrue/BiocPackageSofwareTemplate)
- [Bioconductor Package Guidelines for Developers and Reviewers](https://github.com/kevinrue/bioc_package_guide)
- [Building a Bioconductor package using RStudio](https://github.com/SaskiaFreytag/making_bioconductor_pkg)
- [lshep/MakeAPackage](https://github.com/lshep/MakeAPackage)